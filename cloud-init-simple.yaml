#cloud-config
# Cloud-init для Timeweb (ПРОСТАЯ ВЕРСИЯ - без SSH ключей)
# Используйте эту версию, если у вас нет SSH ключа

# Настройка пользователей
users:
  - name: ozon
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    # Установим пароль (можно изменить после входа)
    # Пароль: OzonParser2025! (хэш ниже)
    # Сгенерирован командой: mkpasswd --method=SHA-512 --rounds=4096
    # ВАЖНО: Смените пароль после первого входа командой: passwd
    lock_passwd: false
    passwd: $6$rounds=4096$salt$hashedpassword

# Настройка hostname
hostname: ozon-parser
fqdn: ozon-parser.local

# Обновление пакетов
package_update: true
package_upgrade: true

# Установка пакетов
packages:
  - git
  - curl
  - wget
  - htop
  - vim
  - nano
  - python3
  - python3-pip
  - python3-venv
  - python3-dev
  - libnss3
  - libnspr4
  - libatk1.0-0
  - libatk-bridge2.0-0
  - libcups2
  - libdrm2
  - libdbus-1-3
  - libxkbcommon0
  - libxcomposite1
  - libxdamage1
  - libxfixes3
  - libxrandr2
  - libgbm1
  - libasound2
  - libpango-1.0-0
  - libcairo2
  - nginx
  - ufw

# Timezone
timezone: Europe/Moscow

# Команды
runcmd:
  # Firewall
  - ufw allow ssh
  - ufw allow 8000/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - echo "y" | ufw enable
  
  # Директории
  - mkdir -p /home/ozon/ozon_parser/{logs,screenshots,browser_state}
  - chown -R ozon:ozon /home/ozon/ozon_parser
  
  # Swap 2 ГБ
  - fallocate -l 2G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo '/swapfile none swap sw 0 0' >> /etc/fstab

final_message: |
  ✅ Сервер готов!
  
  Подключение: ssh ozon@YOUR_SERVER_IP
  Пароль: OzonParser2025! (смените после входа: passwd)
