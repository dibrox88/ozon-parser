#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç (9:00-21:00 –ú–°–ö)

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞..."
echo ""

# –ü—É—Ç—å –∫ –ø–∞—Ä—Å–µ—Ä—É
PARSER_DIR="$HOME/ozon_parser"
VENV_PATH="$PARSER_DIR/venv/bin/activate"
LOG_FILE="$PARSER_DIR/logs/cron.log"

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p "$PARSER_DIR/logs"

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
cat > "$PARSER_DIR/run_parser.sh" << 'EOF'
#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –¥–ª—è cron

cd ~/ozon_parser
source venv/bin/activate

# –î–æ–±–∞–≤–ª—è–µ–º timestamp –≤ –ª–æ–≥
echo "$(date '+%Y-%m-%d %H:%M:%S') - –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞..." >> logs/cron.log

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–µ—Ä –∏ –ª–æ–≥–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
python main.py >> logs/cron.log 2>&1

# –ö–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
EXIT_CODE=$?
echo "$(date '+%Y-%m-%d %H:%M:%S') - –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å –∫–æ–¥–æ–º: $EXIT_CODE" >> logs/cron.log
echo "----------------------------------------" >> logs/cron.log

exit $EXIT_CODE
EOF

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$PARSER_DIR/run_parser.sh"

echo "‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç: $PARSER_DIR/run_parser.sh"
echo ""

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É
# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç —Å 9:00 –¥–æ 21:00 (–ú–°–ö)
CRON_ENTRY="*/15 9-21 * * * $PARSER_DIR/run_parser.sh"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
if crontab -l 2>/dev/null | grep -q "run_parser.sh"; then
    echo "‚ö†Ô∏è  Cron –∑–∞–¥–∞—á–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –û–±–Ω–æ–≤–ª—è–µ–º..."
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É
    crontab -l 2>/dev/null | grep -v "run_parser.sh" | crontab -
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
(crontab -l 2>/dev/null; echo "$CRON_ENTRY") | crontab -

echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:"
echo "   $CRON_ENTRY"
echo ""
echo "üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:"
echo "   - –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç"
echo "   - –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 9:00 - 21:00 –ú–°–ö"
echo "   - –õ–æ–≥–∏: $LOG_FILE"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å cron –∑–∞–¥–∞—á–∏: crontab -l"
echo "üìÑ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏: tail -f $LOG_FILE"
echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
