#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Ozon Parser –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Timeweb
# –ó–∞–ø—É—Å–∫–∞—Ç—å –æ—Ç –∏–º–µ–Ω–∏ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ root)

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∞–ª–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Ozon Parser –Ω–∞ Timeweb..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PROJECT_DIR="$HOME/ozon_parser"
VENV_DIR="$PROJECT_DIR/venv"
SERVICE_NAME="ozon-parser-api"
USER=$(whoami)

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -eq 0 ]; then 
   echo -e "${RED}‚ùå –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç root!${NC}"
   echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: bash deploy.sh"
   exit 1
fi

echo -e "${GREEN}‚úì${NC} –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $USER"

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo -e "\n${YELLOW}üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã...${NC}"
sudo apt update
sudo apt upgrade -y

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
echo -e "\n${YELLOW}üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    curl \
    wget \
    nginx \
    supervisor \
    tzdata

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Playwright —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "\n${YELLOW}üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Playwright...${NC}"
sudo apt install -y \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libpango-1.0-0 \
    libcairo2

# 4. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo -e "\n${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"

# 5. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–µ—Å–ª–∏ –µ—â—ë –Ω–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω)
if [ ! -d "$PROJECT_DIR/.git" ]; then
    echo -e "\n${YELLOW}üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...${NC}"
    echo "–í–≤–µ–¥–∏—Ç–µ URL –≤–∞—à–µ–≥–æ git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):"
    read -r GIT_REPO_URL
    
    if [ -n "$GIT_REPO_URL" ]; then
        git clone "$GIT_REPO_URL" .
    else
        echo -e "${YELLOW}‚ö†Ô∏è  –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é –≤ $PROJECT_DIR${NC}"
    fi
fi

# 6. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo -e "\n${YELLOW}üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è Python...${NC}"
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"

# 7. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo -e "\n${YELLOW}üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –ø–∞–∫–µ—Ç–æ–≤...${NC}"
if [ -f "requirements-production.txt" ]; then
    pip install --upgrade pip
    pip install -r requirements-production.txt
else
    echo -e "${RED}‚ùå –§–∞–π–ª requirements-production.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi

# 8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright
echo -e "\n${YELLOW}üé≠ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright...${NC}"
playwright install chromium
playwright install-deps chromium

# 9. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ timezone –Ω–∞ Moscow
echo -e "\n${YELLOW}‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ (Europe/Moscow)...${NC}"
sudo timedatectl set-timezone Europe/Moscow

# 10. –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
echo -e "\n${YELLOW}üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"
if [ ! -f "$PROJECT_DIR/.env" ]; then
    echo "–°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
    cat > "$PROJECT_DIR/.env" << EOF
# API Secret Key (–ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô!)
API_SECRET_KEY=$(openssl rand -hex 32)

# Telegram Bot (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_CHAT_ID=your_chat_id_here

# Google Sheets
GOOGLE_CREDENTIALS_FILE=google_credentials.json
GOOGLE_SHEETS_URL=your_sheets_url_here

# Ozon credentials
OZON_EMAIL=your_email@example.com
OZON_PASSWORD=your_password_here
EOF
    
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª .env —Å–æ–∑–¥–∞–Ω —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è  –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ $PROJECT_DIR/.env –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º!${NC}"
else
    echo -e "${GREEN}‚úì${NC} –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# 11. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –ª–æ–≥–æ–≤ –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
echo -e "\n${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
mkdir -p "$PROJECT_DIR/logs"
mkdir -p "$PROJECT_DIR/screenshots"
mkdir -p "$PROJECT_DIR/browser_state"

# 12. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo -e "\n${YELLOW}üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
chmod 700 "$PROJECT_DIR/.env"
chmod 700 "$PROJECT_DIR/google_credentials.json" 2>/dev/null || true

echo -e "\n${GREEN}‚úÖ –ë–∞–∑–æ–≤–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo -e "\n${YELLOW}üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ $PROJECT_DIR/.env —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
echo "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ google_credentials.json –≤ $PROJECT_DIR/"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ systemd: bash setup-systemd.sh"
echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron: bash setup-cron.sh"
