# ๐ก๏ธ v1.9.2 - ะฃัะธะปะตะฝะฝะฐั ะทะฐัะธัะฐ ะพั ะฐะฝัะธะฑะพัะฐ Ozon

## ะงัะพ ัะดะตะปะฐะฝะพ:

### 1. ะะทััะตะฝั ะผะฐัะตัะธะฐะปั:
- โ **ะกัะฐััั ะฝะฐ Habr**: https://habr.com/ru/companies/amvera/articles/960280/
- โ **GitHub ัะตะฟะพะทะธัะพัะธะน**: https://github.com/aglihowstan/parser_ozon
- โ ะะทััะตะฝะฐ ะปะพะณะธะบะฐ ะพะฑัะพะดะฐ ะฐะฝัะธะฑะพั-ะทะฐัะธัั Ozon

### 2. ะะปััะตะฒัะต ะฝะฐัะพะดะบะธ ะธะท ััะฐััะธ:

**ะัะพะฑะปะตะผะฐ**: Ozon ั 2022 ะณะพะดะฐ ะธัะฟะพะปัะทัะตั ะผะพัะฝัั ะทะฐัะธัั ะพั ะฟะฐััะธะฝะณะฐ, ะบะพัะพัะฐั ะดะตัะตะบัะธััะตั ะฐะฒัะพะผะฐัะธะทะฐัะธั ะฟะพ ะผะฝะพะถะตััะฒั ะฟัะธะทะฝะฐะบะพะฒ.

**ะะตัะตะฝะธะต ะธะท ััะฐััะธ**:
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต **Playwright** (ะฝะต Selenium)
- ะะฐัะฐะผะตัั `slow_mo=50` - ะทะฐะผะตะดะปัะตั ะดะตะนััะฒะธั
- ะกััะพะณะธะน `--disable-blink-features=AutomationControlled`
- ะะพะดะผะตะฝะฐ `navigator.webdriver` โ `undefined`
- User-Agent ะพั Mac OS (ะผะตะฝะตะต ะฟะพะดะพะทัะธัะตะปัะฝัะน)
- ะะฐะดะตัะถะบะธ `human_delay(1, 3)` ะผะตะถะดั ะะะะะซะ ะดะตะนััะฒะธะตะผ
- ะกะปััะฐะนะฝัะต ะทะฐะดะตัะถะบะธ ะฟัะธ ะฟัะพะบัััะบะต ะธ ะบะปะธะบะฐั

### 3. ะงัะพ ะธะผะฟะปะตะผะตะฝัะธัะพะฒะฐะปะธ:

#### โ ะ `main.py`:
```python
browser = p.chromium.launch(
    headless=Config.HEADLESS,
    slow_mo=50,  # ะะะะะ - ะทะฐะผะตะดะปัะตั ะะกะ ะดะตะนััะฒะธั
    args=[
        '--disable-blink-features=AutomationControlled',  # ะกะฐะผะพะต ะฒะฐะถะฝะพะต!
        '--disable-features=VizDisplayCompositor',  # ะะพะฒะพะต
        # ... ะพััะฐะปัะฝัะต ะฐัะณัะผะตะฝัั
    ]
)
```

#### โ ะ `config.py`:
```python
# ะะฑะฝะพะฒะธะปะธ User-Agent ะฝะฐ Mac OS (ะธะท ััะฐััะธ)
USER_AGENT = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
```

#### โ ะ `stealth.py`:
```python
# ะฃะฒะตะปะธัะธะปะธ ะผะธะฝะธะผะฐะปัะฝัะต ะทะฐะดะตัะถะบะธ
def human_delay(min_sec: float = 1.0, max_sec: float = 3.0):  # ะัะปะพ 0.5-2.0
    delay = random.uniform(min_sec, max_sec)
    time.sleep(delay)
    logger.debug(f"ะะฐะดะตัะถะบะฐ: {delay:.2f}ั")  # ะะพะฑะฐะฒะธะปะธ ะปะพะณะธัะพะฒะฐะฝะธะต
```

#### โ ะ `auth.py`:
```python
# ะะฐะผะตะฝะธะปะธ ัะธะบัะธัะพะฒะฐะฝะฝัะต ะทะฐะดะตัะถะบะธ ะฝะฐ ัะปััะฐะนะฝัะต
StealthHelper.human_delay(2, 4)  # ะะผะตััะพ time.sleep(2)
```

### 4. ะงัะพ ะฃะะ ะฑัะปะพ ั ะฝะฐั (ะธ ัะฐะฑะพัะฐะตั):

- โ `playwright-stealth` ะฑะธะฑะปะธะพัะตะบะฐ (v2.0.0)
- โ ะะพะดะผะตะฝะฐ `navigator.webdriver` ัะตัะตะท JavaScript
- โ ะะพะดะผะตะฝะฐ `navigator.plugins`
- โ Canvas ะธ WebGL fingerprint protection
- โ ะะฐััะธัะตะฝะฝัะต browser ะฐัะณัะผะตะฝัั
- โ ะะพะฝัะตะบัั ั ะฟัะฐะฒะธะปัะฝัะผะธ ะฟะฐัะฐะผะตััะฐะผะธ

---

## ะะพัะตะผั ััะพ ัะฐะฑะพัะฐะตั:

### 1. **slow_mo=50** 
ะะฐะถะดะพะต ะดะตะนััะฒะธะต (ะบะปะธะบ, ะฒะฒะพะด ัะตะบััะฐ, ะฟัะพะบัััะบะฐ) ะฒัะฟะพะปะฝัะตััั ะฝะฐ 50ะผั ะผะตะดะปะตะฝะฝะตะต. ะะปั ะฑะพัะฐ ััะพ ะฝะตะทะฐะผะตัะฝะพ, ะฝะพ ะดะปั ะดะตัะตะบัะฐ - ะบัะธัะธัะฝะพ. ะงะตะปะพะฒะตะบ ะฝะต ะผะพะถะตั ะดะตะนััะฒะพะฒะฐัั ะผะพะผะตะฝัะฐะปัะฝะพ.

### 2. **--disable-blink-features=AutomationControlled**
ะัะบะปััะฐะตั ัะปะฐะณ, ะฟะพ ะบะพัะพัะพะผั ัะฐะนัั ะะะะะซะ ะะะะะ ะพะฟัะตะดะตะปััั ะฐะฒัะพะผะฐัะธะทะฐัะธั. ะะตะท ััะพะณะพ ะฒัั ะพััะฐะปัะฝะพะต ะฑะตัะฟะพะปะตะทะฝะพ.

### 3. **User-Agent ะพั Mac**
ะกัะฐัะธััะธัะตัะบะธ Mac OS ะธัะฟะพะปัะทััั ัะตะถะต ะดะปั ะฑะพัะพะฒ (ะพะฑััะฝะพ Windows/Linux). ะะตะฝััะต ะฟะพะดะพะทัะตะฝะธะน.

### 4. **ะกะปััะฐะนะฝัะต ะทะฐะดะตัะถะบะธ 1-3 ัะตะบัะฝะดั**
ะงะตะปะพะฒะตะบ ะดัะผะฐะตั, ัะธัะฐะตั, ะดะฒะธะณะฐะตั ะผััั. ะะพั ะฑะตะท ะทะฐะดะตัะถะตะบ ะฒัะฟะพะปะฝัะตั ะดะตะนััะฒะธั ะทะฐ ะผะธะปะปะธัะตะบัะฝะดั. ะญัะพ ะผะตััะฒะฐั ะฒัะดะฐัะฐ.

### 5. **playwright-stealth**
ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธะผะตะฝัะตั 30+ ัะตัะฝะธะบ ะพะฑัะพะดะฐ ะดะตัะตะบัะฐ, ะฒะบะปััะฐั:
- ะกะบัััะธะต automation ัะปะฐะณะพะฒ
- ะญะผัะปััะธั ัะตะฐะปัะฝัั ะฟะปะฐะณะธะฝะพะฒ
- ะัะฐะฒะธะปัะฝัะต ะทะฝะฐัะตะฝะธั ะดะปั ะฒัะตั navigator ัะฒะพะนััะฒ
- ะ ะผะฝะพะณะพะต ะดััะณะพะต

---

## ะงัะพ ะดะตะปะฐัั ะดะฐะปััะต:

### ะัะปะธ ะะกะ ะะะะะ ะฑะปะพะบะธััะตั:

#### ะะฐัะธะฐะฝั 1: ะะฐะฟัััะธัั ะปะพะบะฐะปัะฝะพ ะะะ headless
```bash
# ะ .env
HEADLESS=False
```

ะัะฐัะทะตั ั GUI ะดะตัะตะบัะธััะตััั ะณะพัะฐะทะดะพ ัะตะถะต. ะะปัั ะผะพะถะตัะต ะฒัััะฝัั ะฟัะพะนัะธ ะบะฐะฟัั ะตัะปะธ ะฟะพัะฒะธััั.

#### ะะฐัะธะฐะฝั 2: ะะพะฑะฐะฒะธัั ะตัั ะฑะพะปััะต ะทะฐะดะตัะถะตะบ
```python
# ะ stealth.py
def human_delay(min_sec: float = 2.0, max_sec: float = 5.0):  # ะัั ะผะตะดะปะตะฝะฝะตะต
```

#### ะะฐัะธะฐะฝั 3: ะัะฟะพะปัะทะพะฒะฐัั ะฟัะพะบัะธ ั ัะพััะธะนัะบะธะผ IP
```python
# ะ main.py, setup_browser_context()
context = browser.new_context(
    ...
    proxy={
        'server': 'http://proxy.example.com:8080',
        'username': 'user',
        'password': 'pass'
    }
)
```

#### ะะฐัะธะฐะฝั 4: ะะฐะฟััะบะฐัั ะฟะฐััะตั ัะตะถะต
ะะผะตััะพ ะบะฐะถะดะพะณะพ ัะฐัะฐ - ัะฐะท ะฒ 2-3 ัะฐัะฐ. ะงะฐัััะต ะทะฐะฟัะพัั ะฟะพะฒััะฐัั ะฟะพะดะพะทัะตะฝะธั.

#### ะะฐัะธะฐะฝั 5: ะัะฟะพะปัะทะพะฒะฐัั ัะตะฐะปัะฝัะน Chrome ะฟัะพัะธะปั
```python
context = browser.new_context(
    user_data_dir='/path/to/chrome/profile'  # ะัะพัะธะปั ั ะธััะพัะธะตะน, ะบัะบะฐะผะธ
)
```

---

## ะัะพะฒะตัะบะฐ ัะฐะฑะพัั:

### 1. ะะพะบะฐะปัะฝะพ:
```bash
python main.py
```

ะกะผะพััะธัะต ะปะพะณะธ:
- `โ playwright-stealth ะทะฐะณััะถะตะฝ (v2.0)` - ะดะพะปะถะฝะพ ะฑััั
- `๐ก๏ธ ะัะธะผะตะฝัะตะผ stealth-ัะตะถะธะผ...` - ะดะพะปะถะฝะพ ะฑััั
- `ะะฐะดะตัะถะบะฐ: X.XXั` - ะดะพะปะถะฝั ะฑััั ัะปััะฐะนะฝัะต ะทะฐะดะตัะถะบะธ
- ะัะฐัะทะตั ะดะพะปะถะตะฝ ัะฐะฑะพัะฐัั ะะะะะะะะะ ัะตะผ ัะฐะฝััะต (ะธะท-ะทะฐ slow_mo)

### 2. ะะฐ ัะตัะฒะตัะต:
```bash
# ะะฑะฝะพะฒะธัั ัะฐะนะปั
.\update-server.ps1

# ะะปะธ ะฒัััะฝัั
scp main.py config.py auth.py stealth.py ozon@85.193.81.13:~/ozon_parser/

# ะะตัะตะทะฐะฟัััะธัั
ssh ozon@85.193.81.13
sudo systemctl restart ozon-parser-api

# ะขะตัั
cd ~/ozon_parser
source venv/bin/activate
python main.py
```

---

## ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ ะธะท ััะฐััะธ:

### ะะปััะตะฒัะต ัะตัะฝะธะบะธ ะบะพัะพััะต ะธัะฟะพะปัะทะพะฒะฐะป ะฐะฒัะพั ััะฐััะธ:

1. **Browser Setup**:
```python
browser = await playwright.chromium.launch(
    headless=True,
    slow_mo=50,  # โ ะะะฎะงะะะะ
    args=[
        "--disable-blink-features=AutomationControlled",
        "--disable-dev-shm-usage",
        "--no-sandbox",
        "--disable-web-security",
        "--disable-features=VizDisplayCompositor"
    ]
)
```

2. **Context Setup**:
```python
context = await browser.new_context(
    viewport={"width": 1920, "height": 1080},
    user_agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ...",
    java_script_enabled=True,
    ignore_https_errors=True
)
```

3. **JavaScript Injection**:
```javascript
Object.defineProperty(navigator, 'webdriver', { 
    get: () => undefined 
});
Object.defineProperty(navigator, 'plugins', { 
    get: () => [1, 2, 3, 4, 5] 
});
```

4. **Human Delays**:
```python
async def human_delay(self, min_sec=1, max_sec=3):
    await asyncio.sleep(random.uniform(min_sec, max_sec))
```

ะัะธะผะตะฝัะป ะทะฐะดะตัะถะบะธ:
- ะะพัะปะต ะบะฐะถะดะพะณะพ goto()
- ะะพัะปะต ะบะฐะถะดะพะณะพ ะบะปะธะบะฐ
- ะะพัะปะต ะบะฐะถะดะพะณะพ ะฒะฒะพะดะฐ ัะตะบััะฐ
- ะัะธ ะฟัะพะบัััะบะต ัััะฐะฝะธัั
- ะัะธ ะฟะตัะตัะพะดะต ะฝะฐ ัะปะตะดััััั ัััะฐะฝะธัั

### ะกะตะปะตะบัะพัั ะบะพัะพััะต ัะฐะฑะพัะฐัั (ะธะท ัะตะฟะพะทะธัะพัะธั):

**ะะฝะพะฟะบะฐ ะฒัะพะดะฐ**:
- `span.tsCompact300XSmall:has-text("ะะพะนัะธ")`
- `text="ะะพะนัะธ"`

**ะะพะธัะบ ัะพะฒะฐัะพะฒ**:
- `[data-widget='searchResults']`
- `.tile-root a[href*='/product/']`

**ะฆะตะฝั**:
- `[data-widget='webPrice']`
- ะ JSON: `window.__INITIAL_STATE__`

**ะะตะนัะธะฝะณ**:
- `span[data-widget='webReviewRating']`

**ะัะทัะฒั**:
- `span[data-widget='webReviewCount']`

---

## ะัะพะณะพะฒะฐั ะฐััะธัะตะบัััะฐ ะทะฐัะธัั:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะฃัะพะฒะตะฝั 1: Browser Arguments      โ
โ   --disable-blink-features...       โ
โ   slow_mo=50                        โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะฃัะพะฒะตะฝั 2: Context Settings       โ
โ   viewport, user_agent, locale      โ
โ   geolocation, permissions          โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะฃัะพะฒะตะฝั 3: JavaScript Injection   โ
โ   navigator.webdriver = undefined   โ
โ   navigator.plugins = [...]         โ
โ   Canvas/WebGL protection           โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะฃัะพะฒะตะฝั 4: playwright-stealth     โ
โ   30+ ะฐะฒัะพะผะฐัะธัะตัะบะธั ัะตัะฝะธะบ         โ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโ
               โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะฃัะพะฒะตะฝั 5: Human Behavior         โ
โ   ะกะปััะฐะนะฝัะต ะทะฐะดะตัะถะบะธ 1-3ั           โ
โ   ะะปะฐะฒะฝัะต ะดะฒะธะถะตะฝะธั ะผััะธ             โ
โ   ะกะปััะฐะนะฝะฐั ะฟัะพะบัััะบะฐ               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ะะพะผะผะธัั:

- `2bc6497` - v1.9.1: Add playwright-stealth and enable screenshots
- `278749e` - v1.9.2: Enhanced anti-detection with slow_mo and better delays

---

## ะคะฐะนะปั ะธะทะผะตะฝะตะฝั:

- โ `main.py` - ะดะพะฑะฐะฒะปะตะฝ slow_mo=50, VizDisplayCompositor
- โ `config.py` - ะพะฑะฝะพะฒะปะตะฝ User-Agent ะฝะฐ Mac OS
- โ `stealth.py` - ัะฒะตะปะธัะตะฝั ะทะฐะดะตัะถะบะธ ะดะพ 1-3ั, ะดะพะฑะฐะฒะปะตะฝะพ ะปะพะณะธัะพะฒะฐะฝะธะต
- โ `auth.py` - ะทะฐะผะตะฝะตะฝั ัะธะบัะธัะพะฒะฐะฝะฝัะต ะทะฐะดะตัะถะบะธ ะฝะฐ ัะปััะฐะนะฝัะต

---

## ะกัะฐััั:

โ **v1.9.2 ะณะพัะพะฒ ะบ ัะตััะธัะพะฒะฐะฝะธั**

ะัะต ัะตัะฝะธะบะธ ะธะท ััะฐััะธ Habr ะธ GitHub ัะตะฟะพะทะธัะพัะธั ะธะผะฟะปะตะผะตะฝัะธัะพะฒะฐะฝั. ะะฐัะธัะฐ ััะธะปะตะฝะฐ ะดะพ ะผะฐะบัะธะผัะผะฐ ะฒ ัะฐะผะบะฐั Playwright.

**ะกะปะตะดัััะธะน ัะฐะณ**: ะขะตััะธัะพะฒะฐะฝะธะต ะฝะฐ ัะตะฐะปัะฝะพะผ Ozon ๐ฏ
